<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>BQNsweeper</title>
<style>
@font-face{
  font-family: BQN386;
  src: url(/BQN386.subset.woff2) format('woff2');
}
pre,code,textarea {
  font-family: BQN386, monospace;
}
textarea, button {
  font-size: 1.2rem;
  line-height: 1.4;
}
#grid > button {
  width: 30px;
  height: 30px;
  padding: 0;
  vertical-align: bottom;
}
</style>
</head>

<body>
<div id="try_again">
  <h2 id="ending_text">BQNsweeper</h2>
  <button onClick="restartGame()">Play again</button>
  <hr/>
</div>
<div id="grid"></div>
<hr/>
<pre id="src"></pre>

<script src="bqn.js"></script>
<script>
  const src = `
  Grid ← {𝕩⥊(↕×´𝕩)∊𝕨•rand.Deal ×´𝕩}
  Pad ← {0∾˘⍉⌽𝕩}⍟4
  Adjacent ← ¬×·+´∘⥊⎉2 3‿3↕Pad
  Spread ← {⍉⌽𝕩∨»𝕩}⍟4
  Flood ← ∧⟜Spread⍟{+´≢𝕩}

  Game ← {count 𝕊 size:
    mines ← count Grid size
    adj ← Adjacent mines
    seen ← size⥊0
    Guess ⇐ {𝕊 x‿y:
      g ← 1⌾(y‿x⊸⊑)size⥊0
      seen ↩ seen ∨ g ∨ Spread (0=adj+mines) Flood g
    }
    Render ⇐ {𝕊: ⊑⟜".x 12345678"¨seen×seen+1+adj-mines}
    Result ⇐ {𝕊: (seen≡¬mines) - ∨´⥊seen∧mines}
  }`

  document.getElementById("src").innerText = src

  const v = 8
  const h = 8

  function restartGame() {
    let Game = run.apply(null, compile(src))
    let obj = Game(list([h,v]), 10)
    let ns = nsget(obj);
    let render = ns("render")
    let result = ns("result")
    let guess = ns("guess")

    const grid = document.getElementById("grid");
    while(grid.firstChild) grid.removeChild(grid.firstChild)
    document.getElementById("ending_text").innerText = "BQNsweeper";

    for (let i=0; i<v; i++) {
      for (let j=0; j<h; j++) {
        let btn = document.createElement("button")
        btn.id = "btn-" + (i * h + j)
          btn.innerText = "."
          btn.addEventListener("click", () => {
            guess(list([j,i]))
            update()
          })
        grid.appendChild(btn)
      }
      grid.appendChild(document.createElement("br"))
    }

    function update() {
      const g = render()
      const res = result();
      const gameOver = res !== 0;
      for (i=0; i<v*h; i++) {
        const btn = document.getElementById("btn-" + i);
        btn.innerText = g[i]
        btn.disabled = gameOver;
      }
      const text = res === 1 ? "You win" : "You lose";
      if(gameOver) {
        document.getElementById("ending_text").innerText = text;
      }
    }
  }

  window.onLoad=restartGame()
  
</script>

</body>
</html>
